package net.zonixmc.exploits.util;

import net.zonixmc.exploits.protocol.PacketDecoder;
import net.zonixmc.exploits.protocol.PacketReceiver;
import io.netty.channel.Channel;
import io.netty.channel.ChannelDuplexHandler;
import io.netty.channel.ChannelPipeline;
import io.netty.handler.codec.ByteToMessageDecoder;
import org.bukkit.craftbukkit.v1_8_R3.entity.CraftPlayer;
import org.bukkit.entity.Player;

public class InjectorUtil {

    public static void injectHandlers(Player player) {

        Channel channel = ((CraftPlayer) player).getHandle().playerConnection.networkManager.channel;

        channel.eventLoop().execute(() -> {

            ChannelPipeline channelPipeline = channel.pipeline();

            ByteToMessageDecoder byteToMessageDecoder = new PacketDecoder(player);
            ChannelDuplexHandler channelDuplexHandler = new PacketReceiver(player);

            if (channelPipeline.get("decompress") != null)
                channelPipeline.addAfter("decompress", "akaDecoder", byteToMessageDecoder);

            else channelPipeline.addAfter("splitter",  "akaDecoder", byteToMessageDecoder);

            channelPipeline.addAfter("decoder", "akaReceiver", channelDuplexHandler);

        });

    }

    public static void unInjectHandlers(Player player) {

        Channel channel = ((CraftPlayer) player).getHandle().playerConnection.networkManager.channel;

        channel.eventLoop().execute(() -> {

            ChannelPipeline channelPipeline = channel.pipeline();

            channelPipeline.remove("akaDecoder");
            channelPipeline.remove("akaReceiver");

        });

    }

}
