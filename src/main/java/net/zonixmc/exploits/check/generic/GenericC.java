package net.zonixmc.exploits.check.generic;

import net.zonixmc.exploits.event.PacketReceiveEvent;
import net.zonixmc.exploits.util.Log4jUtil;
import net.zonixmc.exploits.violation.controller.ViolationsController;
import net.zonixmc.exploits.violation.model.Violations;
import net.minecraft.server.v1_8_R3.Packet;
import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;

import java.lang.reflect.Field;
import java.util.logging.Level;

public class GenericC implements Listener {

    @EventHandler(priority = EventPriority.LOW)
    void on(PacketReceiveEvent event) {

        if (event.isCancelled()) return;

        Packet<?> packet = event.getPacket();

        for (Field field : packet.getClass().getDeclaredFields()) {

            try {

                field.setAccessible(true);

                Object value = field.get(packet);

                if (value instanceof String) {

                    String string = ((String) value).toLowerCase();

                    if (Log4jUtil.match(string)) {

                        event.setCancelled(true);

                        Violations violations = ViolationsController.get(event.getPlayer().getName());

                        if (violations.addViolations("genericC", 4)) {

                            event.setCancelled(true);
                            violations.setPunished(true);
                            event.getChannelHandlerContext().channel().close();

                            Bukkit.getLogger().log(Level.WARNING, String.format(

                                    "[BlockExploits] %s was kicked from the server for exceeding the violation limit (%s)", violations.getOwner(), "genericC"

                            ));

                        }

                    }

                }

            }

            catch (Exception exception) { exception.printStackTrace(); }

        }

    }

}
